# java-filmorate

### ER-Диаграмма

![schema.png](schema.png)
SQL-схема: [schema.sql](src%2Fmain%2Fresources%2Fschema.sql)

### Описание таблиц:

#### Таблица ratings:

| Поле        | Тип                                                  | Описание                                            |
|-------------|------------------------------------------------------|-----------------------------------------------------|
| rating_id   | INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY | Автоматически генерируемый ID                       |
| name        | VARCHAR UNIQUE NOT NULL                              | Название рейтинга уникальное и не может быть пустым |
| description | VARCHAR                                              | Описание                                            |

#### Таблица films:

| Поле         | Тип                                                      | Описание                                           |
|--------------|----------------------------------------------------------|----------------------------------------------------|
| film_id      | INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY     | Автоматически генерируемый ID                      |
| name         | VARCHAR NOT NULL                                         | Название фильма не может быть пустым               |
| description  | VARCHAR(200)                                             | Описание длиной до 200 символов                    |
| release_date | DATE                                                     | Дата должна быть не раньше 28.12.1895              |
| duration     | INTEGER                                                  | Продолжительность должна быть положительным числом |
| mpa-id    | INTEGER REFERENCES ratings(rating_id) ON DELETE SET NULL | Ссылка на таблицу ratings                          |

#### Таблица users:

| Поле     | Тип                                                  | Описание                                           |
|----------|------------------------------------------------------|----------------------------------------------------|
| user_id  | INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY | Автоматически генерируемый ID                      |
| email    | VARCHAR UNIQUE NOT NULL                              | Email Не может быть пустым, должен быть уникальным |
| login    | VARCHAR UNIQUE NOT NULL                              | Логин Не может быть пустым, должен быть уникальным |
| name     | VARCHAR                                              | Имя пользователя, может быть пустым                |
| birthday | DATE                                                 | Дата рождения не может быть в будущем              |

#### Таблица genres:

| Поле     | Тип                                                  | Описание                                 |
|----------|------------------------------------------------------|------------------------------------------|
| genre_id | INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY | Автоматически генерируемый ID            |
| name     | VARCHAR UNIQUE NOT NULL                              | Наименование жанра, не может быть пустым |

#### Таблица friends:

| Поле      | Тип                                                             | Описание                                 |
|-----------|-----------------------------------------------------------------|------------------------------------------|
| user_id   | INTEGER REFERENCES users(user_id) ON DELETE CASCADE PRIMARY KEY | Ссылка на таблицу users, PK              |
| friend_id | INTEGER REFERENCES users(user_id) ON DELETE CASCADE PRIMARY KEY | Ссылка на таблицу users, PK              |
| status    | VARCHAR NOT NULL DEFAULT ('UNCONFIRMED')                        | Статус дружбы 'UNCONFIRMED', 'CONFIRMED' |

#### Таблица likes:

| Поле    | Тип                                                             | Описание                    |
|---------|-----------------------------------------------------------------|-----------------------------|
| film_id | INTEGER REFERENCES films(film_id) ON DELETE CASCADE PRIMARY KEY | Ссылка на таблицу films, PK |
| user_id | INTEGER REFERENCES users(user_id) ON DELETE CASCADE PRIMARY KEY | Ссылка на таблицу users, PK |

#### Таблица film_genres:

| Поле     | Тип                                                               | Описание                     |
|----------|-------------------------------------------------------------------|------------------------------|
| film_id  | INTEGER REFERENCES films(film_id) ON DELETE CASCADE PRIMARY KEY   | Ссылка на таблицу films, PK  |
| genre_id | INTEGER REFERENCES genres(genre_id) ON DELETE CASCADE PRIMARY KEY | Ссылка на таблицу genres, PK |

### Примеры основных запросов:

- выборка всех пользователей

```sql
SELECT *
FROM users;
```

- выборка всех фильмов

```sql
SELECT *
FROM films;
```

- выборка пользователя по id

```sql
SELECT *
FROM users
WHERE user_id = 7;
```

- выборка фильма по id

```sql
SELECT *
FROM films
WHERE film_id = 7;
```

- выборка друзей пользователя

```sql
SELECT u.name as user_name,
       f.name as friend_name,
       fs.status
FROM friends fs
         JOIN users u USING (user_id)
         JOIN users f ON fs.friend_id = f.user_id
WHERE u.user_id = 7
ORDER BY friend_name;
```

- выборка 10 самых популярных фильмов

```sql
SELECT ROW_NUMBER() OVER (ORDER BY likes DESC NULLS LAST) AS Row,
       f.name,
       l.likes
FROM films AS f
         JOIN (SELECT film_id,
                      COUNT(user_id) as likes
               FROM likes
               GROUP BY film_id) AS l USING (film_id)
LIMIT 10;
```

### Примеры дополнительных запросов для проверки работоспособности БД:

- количество фильмов, среднее количество лайков по жанрам и по рейтингу

```sql
SELECT g.name,
       r.name,
       COUNT(fg.film_id)      AS film_count,
       ROUND(AVG(l.likes), 2) as avg_likes
FROM film_genres AS fg
         LEFT JOIN (SELECT film_id,
                           COUNT(*) as likes
                    FROM likes
                    GROUP BY film_id) AS l USING (film_id)
         LEFT JOIN films AS f USING (film_id)
         LEFT JOIN genres AS g USING (genre_id)
         LEFT JOIN ratings AS r USING (rating_id)
GROUP BY g.genre_id, r.name;
```

- название фильма и количество лайков

```sql
SELECT f.name,
       l.likes
FROM films AS f
         LEFT JOIN(SELECT film_id,
                          COUNT(*) AS likes
                   FROM likes
                   GROUP BY film_id) AS l USING (film_id)
ORDER BY 2 DESC NULLS LAST;
```

- Количество фильмов по жанрам

```sql
SELECT g.name,
       COUNT(film_id) AS films_count
FROM genres AS g
         LEFT JOIN film_genres AS fg USING (genre_id)
GROUP BY genre_id
ORDER BY films_count DESC NULLS LAST;
```

- Фильмы и пользователи которые поставили лайки

```sql
SELECT f.name AS film_name,
       u.name AS user_name
FROM likes AS l
         JOIN users AS u USING (user_id)
         JOIN films AS f USING (film_id)
ORDER BY 1, 2;
```